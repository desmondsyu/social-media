name: social-media
services:
  social-media-database:
    image: mysql:8.0
    environment:
#      - DB_DATABASE=${MYSQL_DATABASE}
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
    restart: always
    ports:
      - "3310:3306"
    volumes:
      - db_data:/var/lib/mysql
      - ./mysql-init/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - my_network

  consul-server:
    image: hashicorp/consul
    container_name: consul-server
    command: agent -dev -client=0.0.0.0
    ports:
      - "8500:8500"
      - "8600:8600/udp"
    networks:
      - my_network

  gateway:
    image: openjdk:21-jdk
    volumes:
      - ./social-media-backend/gateway:/app/gateway
    working_dir: /app/gateway
    ports:
      - "8080:8080"
    networks:
      - my_network
    command: bash -c "chmod +x ./mvnw && ./mvnw spring-boot:run && tail -f /dev/null"
    depends_on:
      - consul-server

  main-service:
    image: openjdk:21-jdk
    ports:
      - "8081:8081"
    networks:
      - my_network
    volumes:
      - ./social-media-backend/main-service:/app/main-service
    working_dir: /app/main-service
    environment:
      - DB_DATABASE=main_service
      - DB_USERNAME=root
      - DB_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - JWT_KEY=${JWT_KEY}
      - FRONT_END_URL=${FRONT_END_URL}
      - SMTP_USERNAME=${SMTP_USERNAME}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
    command: bash -c "chmod +x ./mvnw && ./mvnw spring-boot:run && tail -f /dev/null"
    depends_on:
      - consul-server
      - social-media-database

  ms-os-user-profile:
    image: openjdk:21-jdk
    ports:
      - "8082:8082"
    networks:
      - my_network
    volumes:
      - ./social-media-backend/ms-os-user-profile:/app/ms-os-user-profile
    working_dir: /app/ms-os-user-profile
    environment:
      - DB_DATABASE=os_user_profile
      - DB_USERNAME=root
      - DB_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - JWT_KEY=${JWT_KEY}
      - FRONT_END_URL=${FRONT_END_URL}
      - SMTP_USERNAME=${SMTP_USERNAME}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
    command: bash -c "chmod +x ./mvnw && ./mvnw spring-boot:run && tail -f /dev/null"
    depends_on:
      - consul-server
      - social-media-database

  ms-ss-user-profile-crud:
    image: openjdk:21-jdk
    ports:
      - "8083:8083"
    networks:
      - my_network
    volumes:
      - ./social-media-backend/ms-ss-user-profile-crud:/app/ms-ss-user-profile-crud
    working_dir: /app/ms-ss-user-profile-crud
    environment:
      - DB_DATABASE=os_user_profile_crud
      - DB_USERNAME=root
      - DB_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - JWT_KEY=${JWT_KEY}
      - FRONT_END_URL=${FRONT_END_URL}
      - SMTP_USERNAME=${SMTP_USERNAME}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
    command: bash -c "chmod +x ./mvnw && ./mvnw spring-boot:run && tail -f /dev/null"
    depends_on:
      - consul-server
      - social-media-database

  social-media-frontend:
    image: node:22.13.0-alpine3.21
    ports:
      - "3000:3000"
    volumes:
      - ./social-media-frontend:/app
    working_dir: /app
    command: sh -c "npm install && npm run dev"
    networks:
      - my_network


volumes:
  db_data:

networks:
  my_network: